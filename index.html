<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Invoice - SMEC</title>
  <style>
    body {
      font-family: 'Helvetica', Arial, sans-serif;
      padding: 0;
      margin: 0;
      background: #fff;
    }

    .invoice-box {
      width: 190mm; /* A4 width minus 10mm margins */
      margin: 10mm auto;
      padding: 10mm;
      background: #fff;
      box-sizing: border-box;
    }

    header {
      text-align: center;
      border-bottom: 2px solid #333;
      padding-bottom: 10px;
      margin-bottom: 15px;
    }

    .gst-line {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      margin-bottom: 8px;
    }

    header h2 {
      margin: 8px 0;
      font-size: 22px;
      color: #333;
    }

    header h3 {
      font-size: 16px;
      margin: 5px 0;
      color: #444;
    }

    header p {
      font-size: 11px;
      color: #555;
      margin: 4px 0;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin: 15px 0;
      font-size: 11px;
    }

    table th, table td {
      border: 1.5px solid #333 !important;
      padding: 6px;
      text-align: center;
      vertical-align: middle;
    }

    table th {
      background-color: #e9ecef;
      font-weight: bold;
    }

    .items th, .tax-summary th {
      background-color: #e9ecef;
    }

    [contenteditable="true"] {
      border: 1px dashed #aaa;
      padding: 2px;
      cursor: text;
    }

    [contenteditable="true"]:hover {
      background: #f8f8f8;
    }

    button.add-item, button.download-pdf {
      display: block;
      margin: 10px auto;
      padding: 8px 16px;
      background: #007bff;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }

    button.add-item:hover, button.download-pdf:hover {
      background: #0056b3;
    }

    .totals {
      text-align: right;
      margin: 15px 0;
    }

    .totals p, .totals h3 {
      margin: 4px 0;
      font-size: 12px;
    }

    .tax-summary {
      margin-top: 15px;
    }

    .bank-details {
      margin: 15px 0;
      font-size: 11px;
      border: 1.5px solid #333;
      padding: 8px;
      background: #f9f9f9;
    }

    .bank-details p {
      margin: 4px 0;
    }

    .terms-sign {
      display: flex;
      justify-content: space-between;
      margin-top: 20px;
      font-size: 11px;
    }

    .terms {
      width: 55%;
    }

    .sign {
      text-align: right;
      width: 40%;
    }

    .parties {
      display: flex;
      justify-content: space-between;
      margin: 15px 0;
    }

    .party {
      width: 48%;
      font-size: 11px;
    }

    @media print {
      body {
        padding: 0;
        margin: 0;
        width: 210mm;
        height: 297mm;
      }
      .invoice-box {
        border: none !important;
        box-shadow: none !important;
        width: 190mm;
        margin: 10mm auto;
        padding: 10mm;
      }
      button.add-item, button.download-pdf {
        display: none !important;
      }
      [contenteditable="true"] {
        border: none !important;
        background: none !important;
        padding: 2px;
      }
      table th, table td {
        border: 1.5px solid #333 !important;
      }
      .gst-line, .parties, .totals, .bank-details, .terms-sign {
        page-break-inside: avoid;
      }
      table {
        page-break-inside: auto;
      }
      tr {
        page-break-inside: avoid;
        page-break-after: auto;
      }
    }
  </style>
</head>
<body>
  <div class="invoice-box" id="invoice">
    <header>
      <div class="gst-line">
        <span><strong>GSTIN:</strong> 29HTKPK5803F1ZE</span>
        <span class="copy-type">Original Copy (Buyer)</span>
      </div>
      <h2 class="title">TAX INVOICE</h2>
      <h3>SRI MANJUNATHA ELECTRICAL & CONTROLS</h3>
      <p>NO 19, 3RD MAIN ROAD, KASTURBANAGAR, NEAR MYSORE ROAD TOLLGATE, BENGALURU - 560026<br>
      Email: srimanjunathaelectricalcontrol@gmail.com | Phone: 9535982016</p>
    </header>

    <table class="meta">
      <tr><th>Invoice No.</th><td contenteditable="true">SMEC/25-26/012</td><th>GR/RR No.</th><td contenteditable="true">-</td></tr>
      <tr><th>Dated</th><td contenteditable="true">22-03-2025</td><th>Transport</th><td contenteditable="true">-</td></tr>
      <tr><th>Place of Supply</th><td contenteditable="true">BANGALORE</td><th>Station</th><td contenteditable="true">-</td></tr>
      <tr><th>Reverse Charge</th><td contenteditable="true">N</td><td></td><td></td></tr>
    </table>

    <div class="parties">
      <div class="party">
        <strong>Billed to:</strong><br>
        <span contenteditable="true">NAMBIAR BUILDERS PRIVATE LIMITED<br>
        2ND FLOOR, P R BUILDING CENTRE, ABOVE CROMA OUTER RING ROAD, KADUBEESANAHALLI<br>
        BENGALURU - 560037<br>
        State: KARNATAKA | Pincode: 560037<br>
        GSTIN / UIN: 29AADCN0664M1Z3</span>
      </div>
      <div class="party">
        <strong>Shipped to:</strong><br>
        <span contenteditable="true">NAMBIAR BELLEZEA, NARAYANAGHATTA VILLAGE, CHANDAPURA<br>
        DODDABOMMASANDRA CIRCLE, NEAR MUTHANALLUR, BENGALURU - 560099<br>
        State: KARNATAKA | Pincode: 560099<br>
        GSTIN / UIN: -</span>
      </div>
    </div>

    <table class="items" id="items">
      <thead>
        <tr>
          <th>S.N.</th><th>Description of Goods</th><th>HSN/SAC</th><th>Qty</th><th>Unit</th><th>Price</th><th>Amount</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>1</td>
          <td contenteditable="true">4 POLE CONTROCTOR</td>
          <td contenteditable="true">8536</td>
          <td contenteditable="true" class="qty">1</td>
          <td contenteditable="true">NOS</td>
          <td contenteditable="true" class="rate">13920.00</td>
          <td class="amount">13920.00</td>
        </tr>
        <tr>
          <td>2</td>
          <td contenteditable="true">ON DELAY TIMER</td>
          <td contenteditable="true">8536</td>
          <td contenteditable="true" class="qty">2</td>
          <td contenteditable="true">NOS</td>
          <td contenteditable="true" class="rate">1210.00</td>
          <td class="amount">2420.00</td>
        </tr>
      </tbody>
    </table>
    <button class="add-item" onclick="addItem()">+ Add Item</button>

    <div class="totals">
      <p><strong>Subtotal:</strong> ₹ <span id="subtotal">16340.00</span></p>
      <p><strong>Total GST (18%):</strong> ₹ <span id="gst">2941.20</span></p>
      <h3><strong>Grand Total:</strong> ₹ <span id="grandTotal">19281.20</span></h3>
    </div>

    <table class="tax-summary" id="tax-summary">
      <thead>
        <tr><th>HSN/SAC</th><th>Tax Rate</th><th>Taxable Amt.</th><th>GST Amt.</th><th>Total Tax</th></tr>
      </thead>
      <tbody></tbody>
    </table>

    <p><strong>Amount in Words:</strong> <span id="amount-in-words">Rupees Nineteen Thousand Two Hundred and Eighty One and Twenty Paise Only</span></p>

    <div class="bank-details">
      <p><strong>Bank Details</strong></p>
      <p>Bank Name: Karnataka Bank</p>
      <p>Account Number: 0572000110296901</p>
      <p>IFSC Code: KARB0000057</p>
    </div>

    <div class="terms-sign">
      <div class="terms">
        <strong>Terms & Conditions</strong>
        <p>1. Goods once sold will not be taken back.<br>
        2. Interest @ 18% p.a. will be charged if payment is late.<br>
        3. Subject to Karnataka Jurisdiction only.</p>
      </div>
      <div class="sign">
        Receiver's Signature:<br><br><br><br>
        For SRI MANJUNATHA ELECTRICAL & CONTROLS<br>
        <strong>Authorized Signatory</strong>
      </div>
    </div>
  </div>

  <button class="download-pdf" onclick="downloadPDF()">Download PDF</button>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    const { jsPDF } = window.jspdf;

    // Convert number to words (Indian numbering system)
    function numberToWords(num) {
      const ones = ['','One','Two','Three','Four','Five','Six','Seven','Eight','Nine','Ten',
                    'Eleven','Twelve','Thirteen','Fourteen','Fifteen','Sixteen','Seventeen','Eighteen','Nineteen'];
      const tens = ['','','Twenty','Thirty','Forty','Fifty','Sixty','Seventy','Eighty','Ninety'];
      const paise = num % 1 !== 0 ? ` and ${tens[Math.floor((num % 1) * 100 / 10)]} ${ones[Math.floor((num % 1) * 100 % 10)]} Paise` : '';
      
      num = Math.floor(num);
      if (num === 0) return 'Zero' + paise;
      
      function convert(n) {
        if (n < 20) return ones[n];
        if (n < 100) return tens[Math.floor(n / 10)] + (n % 10 ? ' ' + ones[n % 10] : '');
        if (n < 1000) return ones[Math.floor(n / 100)] + ' Hundred' + (n % 100 ? ' and ' + convert(n % 100) : '');
        if (n < 100000) return convert(Math.floor(n / 1000)) + ' Thousand' + (n % 1000 ? ' ' + convert(n % 1000) : '');
        if (n < 10000000) return convert(Math.floor(n / 100000)) + ' Lakh' + (n % 100000 ? ' ' + convert(n % 100000) : '');
        return convert(Math.floor(n / 10000000)) + ' Crore' + (n % 10000000 ? ' ' + convert(n % 10000000) : '');
      }
      
      return convert(num) + paise + ' Only';
    }

    function calculateTotals() {
      let subtotal = 0;
      const taxRates = {};
      const GST_RATE = 0.18; // Fixed 18% GST
      
      // Calculate item totals and collect tax rates
      document.querySelectorAll('#items tbody tr').forEach(row => {
        let qty = row.querySelector('.qty')?.innerText.trim();
        let rate = parseFloat(row.querySelector('.rate')?.innerText) || 0;
        
        qty = qty === '' || isNaN(qty) ? 1 : parseFloat(qty);
        rate = isNaN(rate) ? 0 : rate;
        
        let amount = qty * rate;
        row.querySelector('.amount').innerText = amount.toFixed(2);
        subtotal += amount;
        
        let hsn = row.querySelector('td:nth-child(3)').innerText.trim();
        if (!taxRates[hsn]) taxRates[hsn] = { taxable: 0, gst: 0, rate: GST_RATE * 100 };
        taxRates[hsn].taxable += amount;
        taxRates[hsn].gst += amount * GST_RATE;
      });

      // Update tax summary table
      const taxSummaryBody = document.querySelector('#tax-summary tbody');
      taxSummaryBody.innerHTML = '';
      let totalGST = 0;
      for (let hsn in taxRates) {
        let row = document.createElement('tr');
        row.innerHTML = `
          <td>${hsn}</td>
          <td>${taxRates[hsn].rate}%</td>
          <td>${taxRates[hsn].taxable.toFixed(2)}</td>
          <td>${taxRates[hsn].gst.toFixed(2)}</td>
          <td>${taxRates[hsn].gst.toFixed(2)}</td>
        `;
        taxSummaryBody.appendChild(row);
        totalGST += taxRates[hsn].gst;
      }

      let grandTotal = subtotal + totalGST;

      document.getElementById('subtotal').innerText = subtotal.toFixed(2);
      document.getElementById('gst').innerText = totalGST.toFixed(2);
      document.getElementById('grandTotal').innerText = grandTotal.toFixed(2);
      document.getElementById('amount-in-words').innerText = numberToWords(grandTotal);
    }

    function downloadPDF() {
      calculateTotals();
      
      // Clone the invoice element
      const element = document.getElementById('invoice').cloneNode(true);
      
      // Remove buttons and clean contenteditable
      element.querySelectorAll('.add-item, .download-pdf').forEach(btn => btn.remove());
      element.querySelectorAll('[contenteditable="true"]').forEach(el => {
        el.removeAttribute('contenteditable');
        el.style.border = 'none';
        el.style.background = 'none';
        el.style.padding = '2px';
      });

      // Ensure table borders are applied
      element.querySelectorAll('table th, table td').forEach(el => {
        el.style.border = '1.5px solid #333';
      });

      // Create a temporary container for rendering
      const tempContainer = document.createElement('div');
      tempContainer.style.position = 'absolute';
      tempContainer.style.left = '-9999px';
      tempContainer.style.width = '190mm';
      tempContainer.style.padding = '10mm';
      tempContainer.style.background = '#fff';
      tempContainer.appendChild(element);
      document.body.appendChild(tempContainer);

      // Render with html2canvas
      html2canvas(tempContainer, {
        scale: 2,
        width: 794, // 190mm at 96 DPI
        height: 1123, // 277mm (297mm - 20mm margins) at 96 DPI
        useCORS: true,
        backgroundColor: '#fff'
      }).then(canvas => {
        const imgData = canvas.toDataURL('image/jpeg', 0.98);
        const pdf = new jsPDF({
          orientation: 'portrait',
          unit: 'mm',
          format: 'a4'
        });

        // Calculate image dimensions to fit A4 with margins
        const imgWidth = 190; // 210mm - 10mm margins
        const imgHeight = (canvas.height * imgWidth) / canvas.width;
        pdf.addImage(imgData, 'JPEG', 10, 10, imgWidth, imgHeight);

        // Save PDF
        pdf.save('invoice.pdf');

        // Clean up
        document.body.removeChild(tempContainer);
      }).catch(error => {
        console.error('PDF generation failed:', error);
      });
    }

    function addItem() {
      const tbody = document.querySelector('#items tbody');
      const rowCount = tbody.rows.length + 1;
      const newRow = document.createElement('tr');
      newRow.innerHTML = `
        <td>${rowCount}</td>
        <td contenteditable="true">New Item</td>
        <td contenteditable="true">HSN</td>
        <td contenteditable="true" class="qty">1</td>
        <td contenteditable="true">NOS</td>
        <td contenteditable="true" class="rate">0</td>
        <td class="amount">0.00</td>
      `;
      tbody.appendChild(newRow);
      newRow.querySelectorAll('.qty, .rate').forEach(el =>
        el.addEventListener('input', calculateTotals)
      );
      calculateTotals();
    }

    window.onload = () => {
      document.querySelectorAll('.qty, .rate, .meta td[contenteditable]').forEach(cell =>
        cell.addEventListener('input', calculateTotals)
      );
      calculateTotals();
    };
  </script>
</body>
</html>